#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/ioctl.h>
#include <fcntl.h>
#include <unistd.h>

#include "hi_comm_video.h"
#include "bg0806.h"

#ifdef HI_GPIO_I2C
#include "gpioi2c_ex.h"
#else
#include "hi_i2c.h"
#endif


#define DSC_ADDR_BASE 0x0400

//如果系统VDDIO使用3.3V请定义此宏定义值为1
//如果系统VDDIO使用1.8V请定义此宏定义值为0
#define	VDDIO_VOLTAGE_3V3		1	


const unsigned int 	sensor_i2c_addr	=	0x64;		/* I2C Address of bg0803 */
const unsigned int  sensor_addr_byte	=	2;
const unsigned int  sensor_data_byte	=	1;
static int g_fd = -1;
static int flag_init = 0;

extern WDR_MODE_E genSensorMode;
extern HI_U8 gu8SensorImageMode;
extern HI_BOOL bSensorInit;


const HI_U8 Tab_sensor_dsc[768] = {
	//20170206 update dsc	external ldo
	0x0a, 0x5c, 0x09, 0x4a, 0x08, 0x07, 0x06, 0xee, 0x06, 0x23, 0x05, 0x7e, 0x05, 0x21, 0x05, 0x01, 0x05, 0xcc, 0x06, 0xf5, 
	0x08, 0x0b, 0x09, 0x0e, 0x0a, 0x0e, 0x0b, 0x34, 0x0c, 0x42, 0x0e, 0x9b, 0x09, 0xe0, 0x08, 0x71, 0x06, 0xce, 0x05, 0xd7, 
	0x05, 0x19, 0x04, 0x9c, 0x04, 0x54, 0x04, 0x4d, 0x04, 0xd2, 0x05, 0xf8, 0x07, 0x04, 0x07, 0xe3, 0x08, 0xe2, 0x09, 0xfe, 
	0x0b, 0x69, 0x0d, 0xfa, 0x09, 0x62, 0x07, 0x83, 0x05, 0xd8, 0x04, 0xe6, 0x04, 0x44, 0x03, 0xe5, 0x03, 0x82, 0x03, 0x88, 
	0x04, 0x07, 0x05, 0x09, 0x05, 0xfe, 0x06, 0xc5, 0x07, 0xbf, 0x08, 0xe2, 0x0a, 0x68, 0x0d, 0x59, 0x08, 0xf7, 0x06, 0xea, 
	0x05, 0x43, 0x04, 0x55, 0x03, 0xbf, 0x03, 0x43, 0x03, 0x09, 0x02, 0xf7, 0x03, 0x83, 0x04, 0x75, 0x05, 0x5c, 0x06, 0x09, 
	0x06, 0xf5, 0x08, 0x1c, 0x09, 0xa6, 0x0c, 0xc6, 0x08, 0x6a, 0x06, 0x5e, 0x04, 0xa9, 0x03, 0xc7, 0x03, 0x36, 0x02, 0xd1, 
	0x02, 0x99, 0x02, 0x91, 0x02, 0xea, 0x03, 0xdb, 0x04, 0xad, 0x05, 0x4f, 0x06, 0x48, 0x07, 0x62, 0x08, 0xf4, 0x0b, 0x71, 
	0x07, 0xbd, 0x05, 0xd0, 0x04, 0x2a, 0x03, 0x43, 0x02, 0xa1, 0x02, 0x4d, 0x02, 0x08, 0x01, 0xf8, 0x02, 0x58, 0x03, 0x3f, 
	0x03, 0xec, 0x04, 0xa1, 0x05, 0x87, 0x06, 0xa5, 0x08, 0x31, 0x0a, 0xc0, 0x07, 0x5a, 0x05, 0x54, 0x03, 0xa0, 0x02, 0xca, 
	0x02, 0x4a, 0x01, 0xd9, 0x01, 0x9c, 0x01, 0x98, 0x01, 0xf0, 0x02, 0xba, 0x03, 0x70, 0x04, 0x02, 0x04, 0xe5, 0x06, 0x0b, 
	0x07, 0x84, 0x0a, 0x2f, 0x06, 0xdf, 0x04, 0xe4, 0x03, 0x3f, 0x02, 0x6d, 0x01, 0xe9, 0x01, 0x84, 0x01, 0x47, 0x01, 0x3f, 
	0x01, 0x8e, 0x02, 0x31, 0x02, 0xea, 0x03, 0x78, 0x04, 0x5e, 0x05, 0x68, 0x06, 0xea, 0x09, 0x27, 0x06, 0x82, 0x04, 0x81, 
	0x02, 0xe8, 0x02, 0x20, 0x01, 0x9c, 0x01, 0x2c, 0x00, 0xfa, 0x00, 0xea, 0x01, 0x37, 0x01, 0xdc, 0x02, 0x76, 0x02, 0xf6, 
	0x03, 0xd5, 0x04, 0xd7, 0x06, 0x49, 0x08, 0xb0, 0x06, 0x4b, 0x04, 0x42, 0x02, 0xaf, 0x01, 0xde, 0x01, 0x4f, 0x00, 0xe7, 
	0x00, 0xa2, 0x00, 0x92, 0x00, 0xb6, 0x01, 0x5a, 0x01, 0xe4, 0x02, 0x7e, 0x03, 0x3b, 0x04, 0x31, 0x05, 0x88, 0x07, 0xb8, 
	0x06, 0x25, 0x04, 0x0d, 0x02, 0x7a, 0x01, 0xa1, 0x01, 0x1b, 0x00, 0xab, 0x00, 0x5e, 0x00, 0x4e, 0x00, 0x68, 0x00, 0xf2, 
	0x01, 0x62, 0x01, 0xec, 0x02, 0x9e, 0x03, 0x8f, 0x04, 0xe3, 0x07, 0x01, 0x06, 0x0e, 0x04, 0x0d, 0x02, 0x66, 0x01, 0x94, 
	0x01, 0x10, 0x00, 0x99, 0x00, 0x44, 0x00, 0x21, 0x00, 0x34, 0x00, 0x97, 0x01, 0x13, 0x01, 0x94, 0x02, 0x49, 0x03, 0x40, 
	0x04, 0x75, 0x06, 0x92, 0x06, 0x54, 0x04, 0x31, 0x02, 0x96, 0x01, 0xc5, 0x01, 0x18, 0x00, 0x99, 0x00, 0x39, 0x00, 0x21, 
	0x00, 0x21, 0x00, 0x65, 0x00, 0xd6, 0x01, 0x5f, 0x02, 0x0c, 0x02, 0xfa, 0x04, 0x31, 0x06, 0x5b, 0x06, 0x5c, 0x04, 0x41, 
	0x02, 0x9e, 0x01, 0xc5, 0x01, 0x18, 0x00, 0x99, 0x00, 0x39, 0x00, 0x00, 0x00, 0x00, 0x00, 0x59, 0x00, 0xc6, 0x01, 0x4b, 
	0x01, 0xf9, 0x02, 0xf3, 0x04, 0x1d, 0x06, 0x37, 0x06, 0x0e, 0x04, 0x1a, 0x02, 0x92, 0x01, 0xbd, 0x01, 0x18, 0x00, 0xa1, 
	0x00, 0x4a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x59, 0x00, 0xce, 0x01, 0x4b, 0x02, 0x14, 0x02, 0xfa, 0x04, 0x25, 0x06, 0x3f, 
	0x05, 0x82, 0x03, 0xf2, 0x02, 0x87, 0x01, 0xa0, 0x01, 0x28, 0x00, 0xaa, 0x00, 0x62, 0x00, 0x31, 0x00, 0x3c, 0x00, 0x89, 
	0x00, 0xfe, 0x01, 0x7b, 0x02, 0x3a, 0x03, 0x26, 0x04, 0x69, 0x06, 0x82, 0x05, 0xb3, 0x04, 0x02, 0x02, 0x97, 0x01, 0xd2, 
	0x01, 0x43, 0x00, 0xdb, 0x00, 0x99, 0x00, 0x5d, 0x00, 0x75, 0x00, 0xd6, 0x01, 0x4b, 0x01, 0xc7, 0x02, 0x71, 0x03, 0x73, 
	0x04, 0xc7, 0x06, 0xe2, 0x05, 0xcf, 0x04, 0x3c, 0x02, 0xe4, 0x02, 0x1f, 0x01, 0x90, 0x01, 0x30, 0x00, 0xe6, 0x00, 0xcb, 
	0x00, 0xd6, 0x01, 0x2b, 0x01, 0xb5, 0x02, 0x25, 0x02, 0xf3, 0x03, 0xe4, 0x05, 0x42, 0x07, 0xb2, 0x05, 0xe0, 0x04, 0x83, 
	0x03, 0x22, 0x02, 0x67, 0x01, 0xed, 0x01, 0x7d, 0x01, 0x3f, 0x01, 0x14, 0x01, 0x27, 0x01, 0x93, 0x02, 0x10, 0x02, 0x8d, 
	0x03, 0x4c, 0x04, 0x3f, 0x05, 0x9c, 0x07, 0xc1, 0x06, 0x1d, 0x04, 0xce, 0x03, 0x7d, 0x02, 0xb5, 0x02, 0x42, 0x01, 0xd1, 
	0x01, 0x85, 0x01, 0x74, 0x01, 0x88, 0x01, 0xe8, 0x02, 0x71, 0x02, 0xe1, 0x03, 0xc0, 0x04, 0xb6, 0x06, 0x04, 0x08, 0x7f, 
	0x06, 0x40, 0x05, 0x10, 0x03, 0xe0, 0x03, 0x1b, 0x02, 0xab, 0x02, 0x3a, 0x01, 0xe4, 0x01, 0xd4, 0x01, 0xdc, 0x02, 0x50, 
	0x02, 0xce, 0x03, 0x60, 0x04, 0x29, 0x05, 0x32, 0x06, 0x88, 0x09, 0x16, 0x06, 0x63, 0x05, 0x8c, 0x04, 0x66, 0x03, 0xbc, 
	0x03, 0x1b, 0x02, 0xc2, 0x02, 0x79, 0x02, 0x41, 0x02, 0x69, 0x02, 0xde, 0x03, 0x52, 0x03, 0xdf, 0x04, 0xc9, 0x05, 0xc8, 
	0x06, 0xfd, 0x09, 0x46, 0x06, 0x88, 0x05, 0xf8, 0x05, 0x2a, 0x04, 0x42, 0x03, 0xb0, 0x03, 0x4b, 0x02, 0xf3, 0x02, 0xcf, 
	0x02, 0xc5, 0x03, 0x46, 0x03, 0xdf, 0x04, 0x6d, 0x05, 0x46, 0x06, 0x54, 0x07, 0x69, 0x09, 0xe9, 0x06, 0x9d, 0x05, 0xe7, 
	0x06, 0x75, 0x04, 0x68, 0x04, 0x10, 0x03, 0x5c, 0x03, 0x0f, 0x02, 0xeb, 0x02, 0xf6, 0x03, 0x7d, 0x04, 0x0e, 0x04, 0xa7, 
	0x05, 0xc7, 0x06, 0x72, 0x07, 0x84, 0x0a, 0x0d

};

int sensor_i2c_init(void)
{
    if(g_fd >= 0)
    {
        return 0;
    }    
#ifdef HI_GPIO_I2C
    int ret;

    g_fd = open("/dev/gpioi2c_ex", 0);
    if(g_fd < 0)
    {
        printf("Open gpioi2c_ex error!\n");
        return -1;
    }
#else
    int ret;

    g_fd = open("/dev/i2c-0", O_RDWR);
    if(g_fd < 0)
    {
        printf("Open /dev/i2c-0 error!\n");
        return -1;
    }

    ret = ioctl(g_fd, I2C_SLAVE_FORCE, sensor_i2c_addr);
    if (ret < 0)
    {
        printf("CMD_SET_DEV error!\n");
        return ret;
    }
#endif

    return 0;
}

int sensor_i2c_exit(void)
{
    if (g_fd >= 0)
    {
        close(g_fd);
        g_fd = -1;
        return 0;
    }
    return -1;
}
int sensor_read_register(int addr)
{
	int ret;
	int data;
	char recvbuf[4];
	
    if(flag_init == 0)
    {
		sensor_i2c_init();
		flag_init = 1;
    }
	
	if (sensor_addr_byte == 2)
		ret = ioctl(g_fd, I2C_16BIT_REG, 1);
	else
		ret = ioctl(g_fd, I2C_16BIT_REG, 0);
	if (ret < 0) {
		printf("CMD_SET_REG_WIDTH error!\n");
		return -1;
	}
	if (sensor_data_byte == 2)
		ret = ioctl(g_fd, I2C_16BIT_DATA, 1);
	else
		ret = ioctl(g_fd, I2C_16BIT_DATA, 0);
	if (ret < 0) {
		printf("CMD_SET_DATA_WIDTH error!\n");
		return -1;
	}

	if (sensor_addr_byte == 2) {
		recvbuf[0] = addr & 0xff;
		recvbuf[1] = (addr >> 8) & 0xff;
	} else
		recvbuf[0] = addr & 0xff;
		ret = read(g_fd, recvbuf, sensor_addr_byte);
	if (ret < 0) {
		printf("CMD_I2C_READ error!\n");
		return -1;
	}
	if (sensor_data_byte == 2) {
		data = recvbuf[0] | (recvbuf[1] << 8);
	} else{
		data = recvbuf[0];
//		printf("0x%x 0x%x\n", sensor_i2c_addr, data);
	}
	return data;
	
}

int sensor_write_register(int addr, int data)
{
#ifdef HI_GPIO_I2C
    i2c_data.dev_addr = sensor_i2c_addr;
    i2c_data.reg_addr = addr;
    i2c_data.addr_byte_num = sensor_addr_byte;
    i2c_data.data = data;
    i2c_data.data_byte_num = sensor_data_byte;

    ret = ioctl(g_fd, GPIO_I2C_WRITE, &i2c_data);

    if (ret)
    {
        printf("GPIO-I2C write faild!\n");
        return ret;
    }
#else
    if(flag_init == 0)
    {
		sensor_i2c_init();
		flag_init = 1;
    }

    int idx = 0;
    int ret;
    char buf[8];

    buf[idx++] = addr & 0xFF;
    if (sensor_addr_byte == 2)
    {
    	ret = ioctl(g_fd, I2C_16BIT_REG, 1);
        buf[idx++] = addr >> 8;
    }
    else
    {
    	ret = ioctl(g_fd, I2C_16BIT_REG, 0);
    }

    if (ret < 0)
    {
        printf("CMD_SET_REG_WIDTH error!\n");
        return -1;
    }

    buf[idx++] = data;
    if (sensor_data_byte == 2)
    {
    	ret = ioctl(g_fd, I2C_16BIT_DATA, 1);
        buf[idx++] = data >> 8;
    }
    else
    {
    	ret = ioctl(g_fd, I2C_16BIT_DATA, 0);
    }

    if (ret)
    {
        printf("hi_i2c write faild!\n");
        return -1;
    }

    ret = write(g_fd, buf, idx);
    if(ret < 0)
    {
    	printf("I2C_WRITE error!\n");
    	return -1;
    }
#endif
	return 0;
}


void sensor_linear_1080p30_init();



void sensor_init()
{
    sensor_i2c_init();

    sensor_linear_1080p30_init();

	bSensorInit = HI_TRUE;
	
    return ;
}

void sensor_exit()
{
    sensor_i2c_exit();
	flag_init = 0;
    return;
}
void sensor_linear_1080p30_init()
{
	HI_U8	dsc_value,pid;
	HI_U16	i;

	//MCLK=24Mhz,PCLK=75Mhz,30fps
	sensor_write_register(0x0200, 0x0001);
	sensor_write_register(0x000e, 0x0008);//0806_4times_75M_30fps
	sensor_write_register(0x000f, 0x00ae);//row time F_W=2222
	sensor_write_register(0x0013, 0x0001);
	sensor_write_register(0x0021, 0x0000);
	sensor_write_register(0x0022, 0x0025);//vblank
	sensor_write_register(0x0028, 0x0000);
	sensor_write_register(0x0029, 0x0030);
	sensor_write_register(0x002a, 0x0000);
	sensor_write_register(0x002b, 0x0030);
	sensor_write_register(0x0030, 0x0000);
	sensor_write_register(0x0031, 0x00d0);//rstb2rmp1 gap
	sensor_write_register(0x0034, 0x0000);
	sensor_write_register(0x0035, 0x00d0);//tx2rmp2 gap
	sensor_write_register(0x003c, 0x0001);
	sensor_write_register(0x003d, 0x0084);//rmp1_w@pclk domain
	sensor_write_register(0x003e, 0x0005);//ncp
	sensor_write_register(0x0042, 0x0001);
#if	VDDIO_VOLTAGE_3V3
	sensor_write_register(0x005c, 0x07);//lsh_io ctrlbit for 3.3VDDIO
#else
	sensor_write_register(0x005c, 0x00);//lsh_io ctrlbit for 1.8VDDIO
#endif
	sensor_write_register(0x0061, 0x0004);
	sensor_write_register(0x0062, 0x005c);//rmp2_w@pclk domain
	sensor_write_register(0x0064, 0x0000);
	sensor_write_register(0x0065, 0x0080);//rmp1_w@rmpclk domain
	sensor_write_register(0x0067, 0x0001);
	sensor_write_register(0x0068, 0x0090);//rmp2_w@rmpclk domain
	sensor_write_register(0x006c, 0x0003);//pd mipi dphy&dphy ldo
	sensor_write_register(0x007f, 0x0003);
	sensor_write_register(0x0080, 0x0001); //dot en disable
	sensor_write_register(0x0081, 0x0000);
	sensor_write_register(0x0082, 0x000b);
	sensor_write_register(0x0084, 0x0008);
	sensor_write_register(0x0088, 0x0005);//pclk dly
	sensor_write_register(0x008e, 0x0000);
	sensor_write_register(0x008f, 0x0000);
	sensor_write_register(0x0090, 0x0001);
	sensor_write_register(0x0094, 0x0001);//rmp div1
	sensor_write_register(0x0095, 0x0001);//rmp div4
	sensor_write_register(0x009e, 0x0003);//4 times
	sensor_write_register(0x009f, 0x0020);//rmp2gap@rmpclk
	sensor_write_register(0x00b1, 0x007f);
	sensor_write_register(0x00b2, 0x0002);
	sensor_write_register(0x00bc, 0x0002);
	sensor_write_register(0x00bd, 0x0000);
	sensor_write_register(0x0120, 0x0001);//blc on 01 direct
	sensor_write_register(0x0132, 0x0001);//k
	sensor_write_register(0x0133, 0x0060);
	sensor_write_register(0x0139, 0x0007);
	sensor_write_register(0x0139, 0x00ff);
	sensor_write_register(0x013b, 0x0008);
	sensor_write_register(0x01a5, 0x0007);//row noise on 07
	sensor_write_register(0x0160, 0x0000);
	sensor_write_register(0x0161, 0x0030);
	sensor_write_register(0x0162, 0x0000);
	sensor_write_register(0x0163, 0x0030);
	sensor_write_register(0x0164, 0x0000);
	sensor_write_register(0x0165, 0x0030);
	sensor_write_register(0x0166, 0x0000);
	sensor_write_register(0x0167, 0x0030);
	sensor_write_register(0x0206, 0x0000);
	sensor_write_register(0x0207, 0x0000);
	sensor_write_register(0x0053, 0x0000);
	sensor_write_register(0x0054, 0x0028);//plm_cnt
	sensor_write_register(0x0055, 0x0000);//pln_cnt
	
	sensor_write_register(0x00f3, 0x0000);
	sensor_write_register(0x00f4, 0x007b);//plm
	sensor_write_register(0x00f5, 0x0006);//pln,371.25M pll
	
	sensor_write_register(0x006d, 0x0003);//pclk_ctrl, 03 for 1p25,0c for 1p5
	sensor_write_register(0x006c, 0x0000);//ldo_ctrl,00
	sensor_write_register(0x008d, 0x003f);//
	sensor_write_register(0x008e, 0x0000);//oen_ctrl,0c
	sensor_write_register(0x008f, 0x0000);//io_sel_ctrl,03
	sensor_write_register(0x00fa, 0x008f);//ispc,c7
	sensor_write_register(0x0391, 0x0000);//mipi_ctrl1,(raw10)
	sensor_write_register(0x0392, 0x0000);//mipi_ctrl2,default
	sensor_write_register(0x0393, 0x0001);//mipi_ctrl3,default
	sensor_write_register(0x0398, 0x000a);//28(25M),14(50M),0a(100M),08(111.375)
	sensor_write_register(0x0390, 0x0000);//mipi_ctrl0,bit[1],mipi enable
	
	sensor_write_register(0x006e, 0x0000);

	//dsc_k blcc_k different with chip pid
#define BG0806A		0x01
#define BG0806C1	0x07
#define BG0806C2	0x0b
#define BG0806B1	0x03
#define BG0806B2	0x0f
	pid = sensor_read_register(0x45)&0x3f;
	switch(pid){
		case BG0806A:
			sensor_write_register(0x0206, 0x02);
			sensor_write_register(0x0207, 0xc8);
			sensor_write_register(0x0132, 0x01); //k
			sensor_write_register(0x0133, 0x38);
			break;
		case BG0806C1:
		case BG0806C2:
			sensor_write_register(0x0206, 0x02);
			sensor_write_register(0x0207, 0xaa);
			sensor_write_register(0x0132, 0x01); //k
			sensor_write_register(0x0133, 0x56);
			break;
		case BG0806B1:
		case BG0806B2:
		default:
			sensor_write_register(0x0206, 0x02);
			sensor_write_register(0x0207, 0xde);
			sensor_write_register(0x0132, 0x01); //k
			sensor_write_register(0x0133, 0x22);
			break;
	}
	for (i=0; i<768; i++)
	{
		dsc_value= (unsigned short)(Tab_sensor_dsc[i]);
		sensor_write_register(DSC_ADDR_BASE+i, dsc_value);
	}
	sensor_write_register(0x001d, 0x01);
	printf("---	FH8830 BG0806 ipc 30fps inital ok----\n");
}

