// BG0806

#include <stdio.h>
#include <string.h>
#include "xm_i2c.h"
#include "arkn141_isp_sensor_cfg.h"
#include "arkn141_isp_cmos_sensor_io.h"
#define HI_U8 unsigned char

static const HI_U8 Tab_sensor_dsc[768] = {
	//20170206 update dsc	external ldo
	0x0a, 0x5c, 0x09, 0x4a, 0x08, 0x07, 0x06, 0xee, 0x06, 0x23, 0x05, 0x7e, 0x05, 0x21, 0x05, 0x01, 0x05, 0xcc, 0x06, 0xf5, 
	0x08, 0x0b, 0x09, 0x0e, 0x0a, 0x0e, 0x0b, 0x34, 0x0c, 0x42, 0x0e, 0x9b, 0x09, 0xe0, 0x08, 0x71, 0x06, 0xce, 0x05, 0xd7, 
	0x05, 0x19, 0x04, 0x9c, 0x04, 0x54, 0x04, 0x4d, 0x04, 0xd2, 0x05, 0xf8, 0x07, 0x04, 0x07, 0xe3, 0x08, 0xe2, 0x09, 0xfe, 
	0x0b, 0x69, 0x0d, 0xfa, 0x09, 0x62, 0x07, 0x83, 0x05, 0xd8, 0x04, 0xe6, 0x04, 0x44, 0x03, 0xe5, 0x03, 0x82, 0x03, 0x88, 
	0x04, 0x07, 0x05, 0x09, 0x05, 0xfe, 0x06, 0xc5, 0x07, 0xbf, 0x08, 0xe2, 0x0a, 0x68, 0x0d, 0x59, 0x08, 0xf7, 0x06, 0xea, 
	0x05, 0x43, 0x04, 0x55, 0x03, 0xbf, 0x03, 0x43, 0x03, 0x09, 0x02, 0xf7, 0x03, 0x83, 0x04, 0x75, 0x05, 0x5c, 0x06, 0x09, 
	0x06, 0xf5, 0x08, 0x1c, 0x09, 0xa6, 0x0c, 0xc6, 0x08, 0x6a, 0x06, 0x5e, 0x04, 0xa9, 0x03, 0xc7, 0x03, 0x36, 0x02, 0xd1, 
	0x02, 0x99, 0x02, 0x91, 0x02, 0xea, 0x03, 0xdb, 0x04, 0xad, 0x05, 0x4f, 0x06, 0x48, 0x07, 0x62, 0x08, 0xf4, 0x0b, 0x71, 
	0x07, 0xbd, 0x05, 0xd0, 0x04, 0x2a, 0x03, 0x43, 0x02, 0xa1, 0x02, 0x4d, 0x02, 0x08, 0x01, 0xf8, 0x02, 0x58, 0x03, 0x3f, 
	0x03, 0xec, 0x04, 0xa1, 0x05, 0x87, 0x06, 0xa5, 0x08, 0x31, 0x0a, 0xc0, 0x07, 0x5a, 0x05, 0x54, 0x03, 0xa0, 0x02, 0xca, 
	0x02, 0x4a, 0x01, 0xd9, 0x01, 0x9c, 0x01, 0x98, 0x01, 0xf0, 0x02, 0xba, 0x03, 0x70, 0x04, 0x02, 0x04, 0xe5, 0x06, 0x0b, 
	0x07, 0x84, 0x0a, 0x2f, 0x06, 0xdf, 0x04, 0xe4, 0x03, 0x3f, 0x02, 0x6d, 0x01, 0xe9, 0x01, 0x84, 0x01, 0x47, 0x01, 0x3f, 
	0x01, 0x8e, 0x02, 0x31, 0x02, 0xea, 0x03, 0x78, 0x04, 0x5e, 0x05, 0x68, 0x06, 0xea, 0x09, 0x27, 0x06, 0x82, 0x04, 0x81, 
	0x02, 0xe8, 0x02, 0x20, 0x01, 0x9c, 0x01, 0x2c, 0x00, 0xfa, 0x00, 0xea, 0x01, 0x37, 0x01, 0xdc, 0x02, 0x76, 0x02, 0xf6, 
	0x03, 0xd5, 0x04, 0xd7, 0x06, 0x49, 0x08, 0xb0, 0x06, 0x4b, 0x04, 0x42, 0x02, 0xaf, 0x01, 0xde, 0x01, 0x4f, 0x00, 0xe7, 
	0x00, 0xa2, 0x00, 0x92, 0x00, 0xb6, 0x01, 0x5a, 0x01, 0xe4, 0x02, 0x7e, 0x03, 0x3b, 0x04, 0x31, 0x05, 0x88, 0x07, 0xb8, 
	0x06, 0x25, 0x04, 0x0d, 0x02, 0x7a, 0x01, 0xa1, 0x01, 0x1b, 0x00, 0xab, 0x00, 0x5e, 0x00, 0x4e, 0x00, 0x68, 0x00, 0xf2, 
	0x01, 0x62, 0x01, 0xec, 0x02, 0x9e, 0x03, 0x8f, 0x04, 0xe3, 0x07, 0x01, 0x06, 0x0e, 0x04, 0x0d, 0x02, 0x66, 0x01, 0x94, 
	0x01, 0x10, 0x00, 0x99, 0x00, 0x44, 0x00, 0x21, 0x00, 0x34, 0x00, 0x97, 0x01, 0x13, 0x01, 0x94, 0x02, 0x49, 0x03, 0x40, 
	0x04, 0x75, 0x06, 0x92, 0x06, 0x54, 0x04, 0x31, 0x02, 0x96, 0x01, 0xc5, 0x01, 0x18, 0x00, 0x99, 0x00, 0x39, 0x00, 0x21, 
	0x00, 0x21, 0x00, 0x65, 0x00, 0xd6, 0x01, 0x5f, 0x02, 0x0c, 0x02, 0xfa, 0x04, 0x31, 0x06, 0x5b, 0x06, 0x5c, 0x04, 0x41, 
	0x02, 0x9e, 0x01, 0xc5, 0x01, 0x18, 0x00, 0x99, 0x00, 0x39, 0x00, 0x00, 0x00, 0x00, 0x00, 0x59, 0x00, 0xc6, 0x01, 0x4b, 
	0x01, 0xf9, 0x02, 0xf3, 0x04, 0x1d, 0x06, 0x37, 0x06, 0x0e, 0x04, 0x1a, 0x02, 0x92, 0x01, 0xbd, 0x01, 0x18, 0x00, 0xa1, 
	0x00, 0x4a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x59, 0x00, 0xce, 0x01, 0x4b, 0x02, 0x14, 0x02, 0xfa, 0x04, 0x25, 0x06, 0x3f, 
	0x05, 0x82, 0x03, 0xf2, 0x02, 0x87, 0x01, 0xa0, 0x01, 0x28, 0x00, 0xaa, 0x00, 0x62, 0x00, 0x31, 0x00, 0x3c, 0x00, 0x89, 
	0x00, 0xfe, 0x01, 0x7b, 0x02, 0x3a, 0x03, 0x26, 0x04, 0x69, 0x06, 0x82, 0x05, 0xb3, 0x04, 0x02, 0x02, 0x97, 0x01, 0xd2, 
	0x01, 0x43, 0x00, 0xdb, 0x00, 0x99, 0x00, 0x5d, 0x00, 0x75, 0x00, 0xd6, 0x01, 0x4b, 0x01, 0xc7, 0x02, 0x71, 0x03, 0x73, 
	0x04, 0xc7, 0x06, 0xe2, 0x05, 0xcf, 0x04, 0x3c, 0x02, 0xe4, 0x02, 0x1f, 0x01, 0x90, 0x01, 0x30, 0x00, 0xe6, 0x00, 0xcb, 
	0x00, 0xd6, 0x01, 0x2b, 0x01, 0xb5, 0x02, 0x25, 0x02, 0xf3, 0x03, 0xe4, 0x05, 0x42, 0x07, 0xb2, 0x05, 0xe0, 0x04, 0x83, 
	0x03, 0x22, 0x02, 0x67, 0x01, 0xed, 0x01, 0x7d, 0x01, 0x3f, 0x01, 0x14, 0x01, 0x27, 0x01, 0x93, 0x02, 0x10, 0x02, 0x8d, 
	0x03, 0x4c, 0x04, 0x3f, 0x05, 0x9c, 0x07, 0xc1, 0x06, 0x1d, 0x04, 0xce, 0x03, 0x7d, 0x02, 0xb5, 0x02, 0x42, 0x01, 0xd1, 
	0x01, 0x85, 0x01, 0x74, 0x01, 0x88, 0x01, 0xe8, 0x02, 0x71, 0x02, 0xe1, 0x03, 0xc0, 0x04, 0xb6, 0x06, 0x04, 0x08, 0x7f, 
	0x06, 0x40, 0x05, 0x10, 0x03, 0xe0, 0x03, 0x1b, 0x02, 0xab, 0x02, 0x3a, 0x01, 0xe4, 0x01, 0xd4, 0x01, 0xdc, 0x02, 0x50, 
	0x02, 0xce, 0x03, 0x60, 0x04, 0x29, 0x05, 0x32, 0x06, 0x88, 0x09, 0x16, 0x06, 0x63, 0x05, 0x8c, 0x04, 0x66, 0x03, 0xbc, 
	0x03, 0x1b, 0x02, 0xc2, 0x02, 0x79, 0x02, 0x41, 0x02, 0x69, 0x02, 0xde, 0x03, 0x52, 0x03, 0xdf, 0x04, 0xc9, 0x05, 0xc8, 
	0x06, 0xfd, 0x09, 0x46, 0x06, 0x88, 0x05, 0xf8, 0x05, 0x2a, 0x04, 0x42, 0x03, 0xb0, 0x03, 0x4b, 0x02, 0xf3, 0x02, 0xcf, 
	0x02, 0xc5, 0x03, 0x46, 0x03, 0xdf, 0x04, 0x6d, 0x05, 0x46, 0x06, 0x54, 0x07, 0x69, 0x09, 0xe9, 0x06, 0x9d, 0x05, 0xe7, 
	0x06, 0x75, 0x04, 0x68, 0x04, 0x10, 0x03, 0x5c, 0x03, 0x0f, 0x02, 0xeb, 0x02, 0xf6, 0x03, 0x7d, 0x04, 0x0e, 0x04, 0xa7, 
	0x05, 0xc7, 0x06, 0x72, 0x07, 0x84, 0x0a, 0x0d

};

#define	SEN_I2C_ADDR				(0x64 >> 1)
static int I2C_WRITE (unsigned int addr, unsigned int data)
{
	return i2c_reg16_write8(SEN_I2C_ADDR,(addr),(data));	
}

static unsigned int I2C_READ (unsigned int addr)
{
	unsigned int data = 0;
	i2c_reg16_read8 (SEN_I2C_ADDR,(addr), &data);
	return data;
}

typedef struct stSensor_cfg_E2 {
	unsigned int  addr;
	unsigned char data;
} BG0806;

#define	EXTERNAL_LDO_1V5
//如需使用外部1.5V LDO,需定义EXTERNAL_LDO_1V5宏
static struct stSensor_cfg_E2 Sensor_Cfg_1080P30FPS[] =
{
	{0x0200, 0x0001},
	{0x000e, 0x0008},
	{0x000f, 0x00ae},
	{0x0013, 0x0001},
#if FPS_25
	{0x0021, 0x0001},//25帧配置
	{0x0022, 0x0006},
#else
	{0x0021, 0x0000},//30帧配置
	{0x0022, 0x0025},
#endif

	{0x0028, 0x0000},
	{0x0029, 0x0030},
	{0x002a, 0x0000},
	{0x002b, 0x0050},//renzhq 20170621
	{0x0030, 0x0000},
	{0x0031, 0x00c0},//renzhq 20170621
	{0x0034, 0x0000},
	{0x0035, 0x00c0},//renzhq 20170621
	{0x003c, 0x0001},
	{0x003d, 0x0084},
	{0x003e, 0x0005},
	{0x0042, 0x0001},
	                   
	//{0x005c, 0x0000},		// 1.8v IO
	{0x005c, 0x0007},	// 3.3v IO
	              
	{0x0061, 0x0004},
	{0x0062, 0x005c},
	{0x0064, 0x0000},
	{0x0065, 0x0080},
	{0x0067, 0x0001},
	{0x0068, 0x0090},
	{0x006c, 0x0003},
	{0x007f, 0x0003},
	{0x0080, 0x0001},
	{0x0081, 0x0000},
	 {0x0082, 0x000b},
	{0x0084, 0x0008},
	{0x0088, 0x0005},
	{0x008e, 0x0000},
	{0x008f, 0x0000},
	{0x0090, 0x0001},
	{0x0094, 0x0001},
	{0x0095, 0x0001},
	{0x009e, 0x0003},
	{0x009f, 0x0020},
	{0x00b1, 0x007f},
	{0x00b2, 0x0002},
	{0x00bc, 0x0002},
	{0x00bd, 0x0000},
	{0x0120, 0x0001},
	{0x0132, 0x0001},
	{0x0133, 0x0060},
	{0x0139, 0x0007},
	{0x0139, 0x00ff},
	{0x013b, 0x0008},
	{0x01a5, 0x0007},
	{0x0160, 0x0000},
	{0x0161, 0x0030},
	{0x0162, 0x0000},
	{0x0163, 0x0030},
	{0x0164, 0x0000},
	{0x0165, 0x0030},
	{0x0166, 0x0000},
	{0x0167, 0x0030},
	{0x0206, 0x0000},
	{0x0207, 0x0000},
	{0x0053, 0x0000},
	{0x0054, 0x0028},
	{0x0055, 0x0000},
	            
	{0x00f3, 0x0000},
	{0x00f4, 0x007b},
	{0x00f5, 0x0006},
	           
	{0x006d, 0x0003},
	{0x006c, 0x0000},
	{0x008d, 0x003f},
	{0x008e, 0x0000},
	{0x008f, 0x0000},
	{0x00fa, 0x008f},
	{0x0391, 0x0000},
	{0x0392, 0x0000},
	{0x0393, 0x0001},
	{0x0398, 0x000a},
	{0x0390, 0x0000},
	              
	{0x006e, 0x0000},
};

// 1080P模式 12bit
int bg0806_init_12bit  (unsigned int frame_lines)
{
	int i;
	unsigned int pid;
	printf ("cmos sensor bg0806 init 1080P 12bit mode\n");
	
	for(i = 0; i < sizeof(Sensor_Cfg_1080P30FPS)/sizeof(Sensor_Cfg_1080P30FPS[0]); i ++)
	{
		if(I2C_WRITE (Sensor_Cfg_1080P30FPS[i].addr, Sensor_Cfg_1080P30FPS[i].data) < 0)
			return -1;
	}
	
	//dsc_k blcc_k different with chip pid
#define BG0806A	0x01
#define BG0806C1	0x07
#define BG0806C2	0x0b
#define BG0806B1	0x03
#define BG0806B2	0x0f
	pid = I2C_READ(0x45)&0x3f;
	switch(pid){
		case BG0806A:
			if(I2C_WRITE(0x0206, 0x02) < 0)
				return -1;
			if(I2C_WRITE(0x0207, 0xc8) < 0)
				return -1;
			if(I2C_WRITE(0x0132, 0x01) < 0)
				return -1;
			if(I2C_WRITE(0x0133, 0x38) < 0)
				return -1;
			break;
		case BG0806C1:
		case BG0806C2:
			if(I2C_WRITE(0x0206, 0x02) < 0)
				return -1;
			if(I2C_WRITE(0x0207, 0xaa) < 0)
				return -1;
			if(I2C_WRITE(0x0132, 0x01) < 0)
				return -1;
			if(I2C_WRITE(0x0133, 0x56) < 0)
				return -1;
			break;
		case BG0806B1:
		case BG0806B2:
		default:
			if(I2C_WRITE(0x0206, 0x02) < 0)
				return -1;
			if(I2C_WRITE(0x0207, 0xde) < 0)
				return -1;
			if(I2C_WRITE(0x0132, 0x01) < 0)
				return -1;
			if(I2C_WRITE(0x0133, 0x22) < 0)
				return -1;
			break;
	}
	
	#define DSC_ADDR_BASE 0x0400
	unsigned char dsc_value;
	//unsigned short i;
	for (i=0; i<768; i++)
	{
		dsc_value = (unsigned char)(Tab_sensor_dsc[i]);
		if(I2C_WRITE(DSC_ADDR_BASE+i, dsc_value) < 0)
			return -1;
	}
	return I2C_WRITE(0x001d, 0x01);
} 
